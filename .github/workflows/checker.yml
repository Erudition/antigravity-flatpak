name: Check for Upstream Updates

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.BOT_TOKEN }}
          ref: latest

      - name: Fetch Latest Release Info
        id: upstream
        run: |
          DATA=$(curl -s https://antigravity-auto-updater-974169037036.us-central1.run.app/api/update/linux-x64/stable/0/0)
          LATEST_URL=$(echo "$DATA" | jq -r '.url')
          LATEST_SHA=$(echo "$DATA" | jq -r '.sha256hash')
          VERSION=$(echo "$LATEST_URL" | grep -oP 'stable/\K[0-9]+\.[0-9]+\.[0-9]+')

          if [ -z "$LATEST_URL" ] || [ "$LATEST_URL" == "null" ]; then
            echo "Error: Could not fetch latest URL"
            exit 1
          fi

          CURRENT_URL=$(yq -r '.modules[0].sources[0].url' com.google.Antigravity.yml)

          if [ "$LATEST_URL" != "$CURRENT_URL" ]; then
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "url=$LATEST_URL" >> $GITHUB_OUTPUT
            echo "sha=$LATEST_SHA" >> $GITHUB_OUTPUT
          else
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.upstream.outputs.updated == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.BOT_TOKEN }}
          branch: update/v${{ steps.upstream.outputs.version }}
          base: latest
          title: "chore: update Antigravity to v${{ steps.upstream.outputs.version }}"
          body: |
            A new version of Antigravity has been detected.
            
            **Version:** ${{ steps.upstream.outputs.version }}
            **Upstream URL:** ${{ steps.upstream.outputs.url }}
            
            This PR was automatically generated by the update checker.
          commit-message: "chore: update Antigravity source to v${{ steps.upstream.outputs.version }}"
          add-paths: com.google.Antigravity.yml
          delete-branch: true

      - name: Update Manifest (Local for PR tool)
        if: steps.upstream.outputs.updated == 'true'
        run: |
          yq -i ".modules[0].sources[0].url = \"${{ steps.upstream.outputs.url }}\"" com.google.Antigravity.yml
          yq -i ".modules[0].sources[0].sha256 = \"${{ steps.upstream.outputs.sha }}\"" com.google.Antigravity.yml

  on-failure:
    needs: check
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Report Failure
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
        run: |
          gh issue create \
            --repo ${{ github.repository }} \
            --title "Automation Failure: Upstream Version Check" \
            --body "The scheduled upstream version check failed. Please check the [Actions run logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details." \
            --label "bug,automation" || true
