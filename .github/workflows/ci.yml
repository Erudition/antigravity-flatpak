name: CI Build

on:
  pull_request:
    branches: [ latest ]
    paths:
      - 'com.google.Antigravity.yml'
      - '.github/workflows/ci.yml'

permissions:
  pull-requests: write
  contents: write
  issues: write

jobs:
  build:
    name: Build and Verify
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:freedesktop-25.08
      options: --privileged
    steps:
      - uses: actions/checkout@v4

      - name: Build Flatpak
        run: |
          # 1. Setup environment
          [ -f /etc/machine-id ] || dbus-uuidgen | tee /etc/machine-id
          flatpak remote-add --user --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
          
          # 2. Build into OSTree repo. --disable-rofiles-fuse is critical for CI stability.
          dbus-run-session -- flatpak-builder --user --install-deps-from=flathub --disable-rofiles-fuse --force-clean --repo=repo build-dir com.google.Antigravity.yml
          
          # 3. Update repo metadata with static deltas for performance
          flatpak build-update-repo --generate-static-deltas --prune repo
          
          # 4. Create preview bundle
          flatpak build-bundle repo antigravity-preview.flatpak com.google.Antigravity

      - name: Upload Preview Bundle
        uses: actions/upload-artifact@v4
        with:
          name: antigravity-preview-${{ github.event.pull_request.number }}
          path: antigravity-preview.flatpak

  auto-approve:
    needs: build
    if: github.event.pull_request.user.login == 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Approve and Merge Bot PR
        env:
          GH_TOKEN: ${{ secrets.BOT_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr review "$PR_URL" --approve --body "Automated build successful. Merging to latest."
          gh pr merge "$PR_URL" --auto --squash

  on-build-failure:
    needs: build
    if: failure() && github.event.pull_request.user.login == 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Report Build Failure
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh issue create \
            --repo ${{ github.repository }} \
            --title "Automation Failure: Build failed for PR #$PR_NUMBER" \
            --body "The automated build for the version update in PR #$PR_NUMBER failed. Check logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --label "bug,automation" || true
